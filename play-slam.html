<link rel="import" href="../polymer/polymer.html">
<!--
  `<play-slam></play-slam>` #Slam 

A game of cards I played with my daughter's. We are making this game and therefore we are making the rules the same as we played then.

Still freeze cleaners eBay and changed the rules of Italy 
  @demo demo.html
-->
<dom-module id="play-slam">
  <template>
    
    <style>
    :host {
      height:600px;
      display:block;
      background-color:#45a173;
      font-family: 'Open Sans', sans-serif;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
      overflow: hidden;
      -webkit-text-size-adjust: 100%;
      -ms-text-size-adjust: 100%;
      text-size-adjust: 100%;
    }
    </style>
    <div id="container"></div>
      
  </template>
</dom-module>
<script>
  Polymer({
    is: "play-slam",
    ready: function(undefined){
      var prefix = Deck.prefix
      var transform = prefix('transform')
      var translate = Deck.translate
      var $container = this.$.container
      var deck = Deck()
      /* Game State */
      var gP0Cards = [[],[],[],[],[]]
      var gTable =   [[],[],   [],[]]
      var gP1Cards = [[],[],[],[],[]]
      
      deck.mount($container)
      
      this.play(gP0Cards,gP1Cards,gTable,deck)
    },
    play: function(p0Cards, p1Cards, middle, deck){
      deck.shuffle()
      var that = this
      var plan = [
        [0,1], [1,0], [2,0], [3,0], [4,0],
        [1,1], [2,0], [3,0], [4,0],
        [2,1], [3,0], [4,0],
        [3,1], [4,0],
        [4,1],
      ]
      deck.cards.forEach(function (card, i) {
        var theX
        var theY
        var yShift = 0
        var onComplete = function (){}
        card.setSide('back')
        if (card.pos < 15) {
          if (plan[card.pos][1]) {
            onComplete  = function () {
              deck.cards[i].setSide('front')
            }
          }
          theX = 4 - plan[card.pos][0]
          theY = 0
          p0Cards[theX].push(i)
          yShift = p0Cards[theX].length * -10
        } else if (card.pos < 30) {
          if (plan[card.pos-15][1]) {
            onComplete  = function () {
              deck.cards[i].setSide('front')
            }
          } 
          theX = plan[card.pos-15][0]
          theY = 2
          p1Cards[theX].push(i)
          yShift = p1Cards[theX].length * 10
        } else if (card.pos < 40) {
          table[0].push(i)
          theX = 4
          theY = 1
        } else if (card.pos < 50){
          table[3].push(i)
          theX = 0
          theY = 1
        } else if (card.pos == 50) {
          table[1].push(i)
          theX = 1
          theY = 1
        } else {
          table[2].push(i)
          theX = 3
          theY = 1
        }     
        card.animateTo({
          delay: 500 + (52 - card.pos) * 75,
          duration: 500 + card.pos * 27,
          ease: 'quartOut',
          x: ((theX/4) * window.innerWidth - window.innerWidth / 2) * .7,
          y: (((theY/2) * window.innerHeight - window.innerHeight / 2) *.6) + yShift - 30,
          onComplete: onComplete,
        })
      })
      var that.p0 = p0Cards
      var that.p1 = p1Cards
      var that.middle = middle
      var that.deck = deck
      setTimeout(function () {
        that.allowPlay(that.p0,that.p1,that.middle,that.deck)
      }, 8000)
    },
    allowPlay: function(p0,p1,middle,deck){
      var that = this
        function isinArray (ar,findThis) {
          var index = -1
          ar.forEach(function (arr,i) {
            if (arr.indexOf(findThis) !== -1) {
              index = i
            }
          })
          return index
        } 
        function isOnTop(ar,test) { 
          var onTop = false
          ar.forEach(function (arr,i) {
            if (arr.length && arr[arr.length - 1] == test) {
              onTop = true
            }
          })
          return onTop
        } 
      deck.cards.forEach(function (card, i) {
      
        card.$el.removeEventListener('mouseup', that.drop(i,that))
        card.$el.removeEventListener('touchend', that.drop(i,that))
        removeEventListener
        if (isinArray(p0, i) !== -1) {
          // card.enableDragging()
          // card.enableFlipping()
        } else if( isinArray(p1, i) !== -1) {
          if (isOnTop(p1,i)) {
            card.enableDragging()
            card.$el.addEventListener('mouseup', that.drop(i,that))
            card.$el.addEventListener('touchend', that.drop(i,that))
            if (card.side != "front") {
              card.enableFlipping()
            }
          }
          // card.enableFlipping()
        } else {
          card.disableDragging()
          card.disableFlipping()
          
          if (middle[1].indexOf(i) !== -1 || middle[2].indexOf(i) !== -1) {
            card.setSide('front')
          }
        }
      }) 
    },
    place: function(x,y,card,deck,p0,p1,middle){
      /*
        Once a player has got rid of all of there cards 
        by moving them to the middle piles (A || B) 
        than go in to grab mode
       
        You can only take 'from' the top of the piles (pop)
        the positions are:
        > 98765 <= p0
        > aA|Bb <= table nothing leaves the table
        > 01234 <= P1
        p0 & p1:
        can move amongst themselves but not across to the other set if:
          [ is empty || top card is not turned over yet || it contains the same value ]
        can move to A or B if 
        value of the moving card is +1 or -1 of the card it would land on
      
       */
      var card
      var player = 0
      var from = this.getPile(x,y)
      switch (from) {
        case "0":
          card = p0[0].pop()
          break
        case "1":
          card = p0[1].pop()
          break
        case "2":
          card = p0[2].pop()
          break
        case "3":
          card = p0[3].pop()
          break
        case "4":
          card = p0[4].pop()
          break
        case "5":
          player = 1
          card = p1[0].pop()
          break
        case "6":
          player = 1
          card = p1[1].pop()
          break
        case "7":
          player = 1
          card = p1[2].pop()
          break
        case "8":
          player = 1
          card = p1[3].pop()
          break
        case "9":
          player = 1
          card = p1[4].pop()
          break
        }
        console.log(card)
      if (card) {
         switch (to) {
           case "0":
             if (player == 0) {
               p0[0].push(card)
             }
              break
           case "1":
             if (player == 0) {
               p0[1].push(card)
             }
             break
           case "2":
             if (player == 0) {
               p0[2].push(card)
             }
             break
           case "3":
             if (player == 0) {
               p0[3].push(card)
             }
             break
           case "4":
             if (player == 0) {
               p0[4].push(card)
             }
             break
           case "5":
             if (player == 1) {
               p1[0].push(card)
             }
             break
           case "6":
             if (player == 1) {
               p1[1].push(card)
             }
             break
           case "7":
             if (player == 1) {
               p1[2].push(card)
             }
             break
           case "8":
             if (player == 1) {
               p1[3].push(card)
             }
             break
           case "9":
             if (player == 1) {
               p1[4].push(card)
             }
             break
           case "A":
            middle[1].push(card)
            break
          case "B":
            middle[2].push(card)
            break
        }
      }  
      this.allowPlay(p0,p1,middle,deck) 
    },
    drop: function(picked,that){
      return function(event) {
        console.log(
          event.x,
          event.y,
          picked
        )
        that.place(event.x,event.y, picked,that.deck,that.p0,that.p1,that.middle)
      }
      
      
    },
    getPile: function(x,y){
      /*
        The positions are:
         
        > 98765 <= p0
        > aA|Bb <= middle
        > 01234 <= P1
      
        0,0 = "9"
        x: ( (theX/4) * midX) * .7
        y: (((theY/2) * midY) *.6)
      */
      // x 
      var midX = window.innerWidth - window.innerWidth / 2
      if (x < ( (0/4) * midX) * .7) {
        console.log("theX",0)
      } else if (x < ( (1/4) * midX) * .7) {
        console.log("theX",1)
      } else if (x < ( (2/4) * midX) * .7) {
        console.log("theX",2)
      } else if (x < ( (3/4) * midX) * .7) {
        console.log("theX",3)
      } else if (x < ( (4/4) * midX) * .7) {
        console.log("theX",4)
      } 
      
      var midY = window.innerHeight - window.innerHeight / 2
      if (y < (((0/2) * midY) *.6)) {
        console.log("theY",0)
      } else if (y < (((1/2) * midY) *.6)) {
        console.log("theY",1)
      } else if (y < (((2/2) * midY) *.6)) {
        console.log("theY",2)
      } 
      
      return "|"
    },
  })
</script>
